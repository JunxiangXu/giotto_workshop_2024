# Working with multiple samples

Jeff Sheridan

August 7th 2024

## Objective
Giotto allows us to group objects  into a single object that we can analyze together as a single object. Datasets can be spatially distributed in the x, y or z directions. This can be used to create 3D datasets using the Z plane or analyze grouped datasets such as multiple replicates or samples of the same type. Whilst we can integrate multiple datasets, batch effects from samples can impair integration. More complex integration is sometimes required to integrate and cluster samples as one. An example of an integration method is [Harmony](https://www.nature.com/articles/s41592-019-0619-0) integration, which will be explained in greater detail later in this tutorial. 

The following tutorial will explore integrating two visium datasets together

## Background
For this tutorial we will be using two prostate visium datasets produced by 10X Genomics, one an [Adenocarcinoma with Invasive Carcinoma](https://www.10xgenomics.com/datasets/human-prostate-cancer-adenocarcinoma-with-invasive-carcinoma-ffpe-1-standard-1-3-0) and the other a [normal prostate](https://www.10xgenomics.com/datasets/normal-human-prostate-ffpe-1-standard-1-3-0) sample. Details on visium technology can be found in section 6.

## Create individual giotto objects

### Download the data
You need to download the expression matrix and spatial information by running these commands:
```{r, eval=FALSE}
data_dir <- 'data'

dir.create(file.path(data_dir, 'Visium_FFPE_Human_Prostate_Cancer'), showWarnings = T, recursive = T)

# Spatial data adenocarcinom prostate
download.file(url = 'https://cf.10xgenomics.com/samples/spatial-exp/1.3.0/Visium_FFPE_Human_Prostate_Cancer/Visium_FFPE_Human_Prostate_Cancer_spatial.tar.gz', 
              destfile = file.path(data_dir, 'Visium_FFPE_Human_Prostate_Cancer/Visium_FFPE_Human_Prostate_Cancer_spatial.tar.gz'))

# Deat matrix adenocarcinoma prostate
download.file(url = 'https://cf.10xgenomics.com/samples/spatial-exp/1.3.0/Visium_FFPE_Human_Prostate_Cancer/Visium_FFPE_Human_Prostate_Cancer_raw_feature_bc_matrix.tar.gz', 
              destfile = file.path(data_dir, 'Visium_FFPE_Human_Prostate_Cancer/Visium_FFPE_Human_Prostate_Cancer_raw_feature_bc_matrix.tar.gz'))

dir.create(file.path(data_dir, 'Visium_FFPE_Human_Normal_Prostate'), showWarnings = F, recursive = T)

# Spatial data normal prostate
download.file(url = 'https://cf.10xgenomics.com/samples/spatial-exp/1.3.0/Visium_FFPE_Human_Normal_Prostate/Visium_FFPE_Human_Normal_Prostate_spatial.tar.gz',
              destfile = file.path(data_dir, 'Visium_FFPE_Human_Normal_Prostate/Visium_FFPE_Human_Normal_Prostate_spatial.tar.gz'))

# Deat matrix normal prostate
download.file(url = 'https://cf.10xgenomics.com/samples/spatial-exp/1.3.0/Visium_FFPE_Human_Normal_Prostate/Visium_FFPE_Human_Normal_Prostate_raw_feature_bc_matrix.tar.gz',
              destfile = file.path(data_dir, 'Visium_FFPE_Human_Normal_Prostate/Visium_FFPE_Human_Normal_Prostate_raw_feature_bc_matrix.tar.gz'))
```


### create giotto instructions

```{r, eval=FALSE}
library(Giotto)

save_dir <- "~/Documents/GitHub/giotto_workshop_2024/img/03_session1"

instrs = createGiottoInstructions(save_dir = save_dir,
                                  save_plot = TRUE,
                                  show_plot = TRUE,
                                  python_path = NULL)
```

### load visium data into Giotto

First we need to load in the datasets as individual Giotto objects.
```{r, eval=FALSE}
print(data_dir)
print(file.path(data_dir, 'Visium_FFPE_Human_Normal_Prostate'))
## Healthy prostate
N_pros = createGiottoVisiumObject(
  visium_dir = file.path(data_dir, 'Visium_FFPE_Human_Normal_Prostate'),
  expr_data = 'raw',
  png_name = 'tissue_lowres_image.png',
  gene_column_index = 2,
  instructions = instrs
)

## Adenocarcinoma 
C_pros = createGiottoVisiumObject(
  visium_dir = file.path(data_dir, 'Visium_FFPE_Human_Prostate_Cancer'),
  expr_data = 'raw',
  png_name = 'tissue_lowres_image.png',
  gene_column_index = 2,
  instructions = instrs
)
```
```{r, echo=FALSE, out.width="40%", fig.align="center", fig.cap="Structure of Giotto object containing a single dataset."}
knitr::include_graphics("img/03_session1/03_ses1_single_gobject.png")
```


### Healthy prostate tissue coverage
```{r,eval=FALSE}
spatPlot2D(gobject = N_pros, cell_color = 'in_tissue',
           show_image = T, point_size = 2.5,cell_color_code = c('black', 'red'),
           point_alpha = 0.5, save_param = list(save_name = "03_ses1_normal_prostate_tissue"))
```
```{r, echo=FALSE, out.width="70%", fig.align="center", fig.cap="Tissue coverage for the normal prostate sample."}
knitr::include_graphics("img/03_session1/03_ses1_normal_prostate_tissue.png")
```


### Adenocarcinoma prostate tissue coverage
```{r,eval=FALSE}
spatPlot2D(gobject = C_pros, cell_color = 'in_tissue',
           show_image = T, point_size = 2.5,cell_color_code = c('black', 'red'), 
           point_alpha = 0.5, save_param = list(save_name = "03_ses1_adeno_prostate_tissue"))
```
```{r, echo=FALSE, out.width="70%", fig.align="center", fig.cap="Tissue coverage for the adenocarcinoma prostate sample."}
knitr::include_graphics("img/03_session1/03_ses1_adeno_prostate_tissue.png")
```

### Showing the data strucutre for the inidividual objects
```{r, eval=FALSE}
# Printing the file structure for the individual datasets
print(head(pDataDT(N_pros)))
print(N_pros)
```

## Join Giotto Objects

joining with x_shift has the advantage that you can join both 2D and 3D data
 x_padding determines how much distance is between each dataset
 if x_shift = NULL, then the total shift will be guessed from the giotto image

```{r, eval=FALSE}

combined_pros = joinGiottoObjects(gobject_list = list(N_pros, C_pros),
                              gobject_names = c('NP', 'CP'),
                              join_method = 'shift', x_padding = 1000)

# Printing the file structure for the individual datasets
print(head(pDataDT(combined_pros)))
print(combined_pros)

```
```{r, echo=FALSE, out.width="100%", fig.align="center", fig.cap="Structure of Giotto object containing two datasets (left) and cell metadata on the left. Note the addition of multiple images and the addition of the list_ID column to define the dataset."}
knitr::include_graphics("img/03_session1/03_ses1_combined_data.png")
```

## Visualizing combined datasets

The combined dataset can either visualized in the same space or in two separate plots through the group_by variable. To show images both the show_image variable and the image_name variable containing both image names needs to be used.

### Vizualizing in the same plot

```{r, eval=FALSE}
spatPlot2D(gobject = combined_pros, cell_color = 'in_tissue', cell_color_code = c('black', 'red'),
           show_image = T, image_name = c("NP-image", "CP-image"), point_size = 1, 
           point_alpha = 0.5, save_param = list(save_name = "03_ses1_combined_tissue"))
```

```{r, echo=FALSE, out.width="100%", fig.align="center", fig.cap="Structure of Giotto object containing two datasets (left) and cell metadata on the left. Note the addition of multiple images and the addition of the list_ID column to define the dataset."}
knitr::include_graphics("img/03_session1/03_ses1_combined_tissue.png")
```

### Vizualizing on separate plots
```{r, eval=FALSE}
spatPlot2D(gobject = combined_pros, cell_color = 'in_tissue', cell_color_code = c('black', 'pink'),
           show_image = T, image_name = c("NP-image", "CP-image"),
           group_by = 'list_ID', point_alpha = 0.5, point_size = 0.5, cow_n_col = 1,
           save_param = list(save_name = "03_ses1_combined_tissue_group"))
```
```{r, echo=FALSE, out.width="100%", fig.align="center", fig.cap="Structure of Giotto object containing two datasets (left) and cell metadata on the left. Note the addition of multiple images and the addition of the list_ID column to define the dataset."}
knitr::include_graphics("img/03_session1/03_ses1_combined_tissue_group.png")
```

## Splitting combined dataset

The individual objects can be split into single objects again through subsetting the cell metadata.
```{r, eval=FALSE}
# Getting the cell information
combined_cells <- pDataDT(combined_pros)
np_cells <- combined_cells[list_ID == 'NP']

np_split <- subsetGiotto(combined_pros, 
                         cell_ids = np_cells$cell_ID,
                         poly_info = np_cells$cell_ID,
                         spat_unit = 'cell')

spatPlot2D(gobject = np_split, cell_color = 'in_tissue', cell_color_code = c('black', 'red'),
           show_image = T, point_alpha = 0.5, point_size = 0.5, 
           save_param = list(save_name = "03_ses1_split_object"))
```
```{r, echo=FALSE, out.width="100%", fig.align="center", fig.cap="Structure of Giotto object containing two datasets (left) and cell metadata on the left. Note the addition of multiple images and the addition of the list_ID column to define the dataset."}
knitr::include_graphics("img/03_session1/03_ses1_split_object.png")
```

## Analyzing joined objects

The joined objects can be analyzed as if they were a single dataset as seen in section 6.

### Normalization and adding statistics
```{r, eval=FALSE}
# subset on in-tissue spots
metadata = pDataDT(combined_pros)
in_tissue_barcodes = metadata[in_tissue == 1]$cell_ID
combined_pros = subsetGiotto(combined_pros, cell_ids = in_tissue_barcodes)

## filter
combined_pros <- filterGiotto(gobject = combined_pros,
                          expression_threshold = 1,
                          feat_det_in_min_cells = 50,
                          min_det_feats_per_cell = 500,
                          expression_values = c('raw'),
                          verbose = T)

## normalize
combined_pros <- normalizeGiotto(gobject = combined_pros, scalefactor = 6000)

## add gene & cell statistics
combined_pros <- addStatistics(gobject = combined_pros, expression_values = 'raw')

## visualize
spatPlot2D(gobject = combined_pros, 
           cell_color = 'nr_feats', color_as_factor = F, point_size = 1, 
           show_image = T, image_name = c("NP-image", "CP-image"),
           save_param = list(save_name = "ses3_1_feat_expression"))
```
```{r, echo=FALSE, out.width="100%", fig.align="center", fig.cap="Unique feat expression for visium spots for both prostate samples."}
knitr::include_graphics("img/03_session1/ses3_1_feat_expression.png")
```


### Clustering the datasets

```{r, eval=FALSE}
## PCA ##
combined_pros <- calculateHVF(gobject = combined_pros)

combined_pros <- runPCA(gobject = combined_pros, center = TRUE, scale_unit = TRUE)

## cluster and run UMAP ##
# sNN network (default)
combined_pros <- createNearestNetwork(gobject = combined_pros,
                                  dim_reduction_to_use = 'pca', dim_reduction_name = 'pca',
                                  dimensions_to_use = 1:10, k = 15)

# Leiden clustering
combined_pros <- doLeidenCluster(gobject = combined_pros, resolution = 0.2, n_iterations = 1000)

# UMAP
combined_pros = runUMAP(combined_pros)
```

### Vizualizing spatial location of clusters
```{r,eval=FALSE}
spatDimPlot2D(gobject = combined_pros,
              cell_color = 'leiden_clus', show_image = TRUE, 
              image_name = c("NP-image", "CP-image"),
              save_param = list(save_name = "ses3_1_leiden_clus"))
```
```{r, echo=FALSE, out.width="100%", fig.align="center", fig.cap="Leiden clustering for the normal prostate (left) and the adenocarcinoma prostate sample (right)."}
knitr::include_graphics("img/03_session1/ses3_1_leiden_clus.png")
```


### Vizualizing tissue contribution to clusters
We can see that the samples are clustered distinctly within the UMAP.
```{r, eval=FALSE}
spatDimPlot2D(gobject = combined_pros,
              cell_color = 'list_ID',show_image = TRUE, 
              image_name = c("NP-image", "CP-image"),
              save_param = list(save_name = "ses3_1_tissue_contribution"))
```
```{r, echo=FALSE, out.width="100%", fig.align="center", fig.cap="Tissue contribution for leiden clustering for the normal prostate (left) and the adenocarcinoma prostate sample (right)."}
knitr::include_graphics("img/03_session1/ses3_1_tissue_contribution.png")
```


## Perform Harmony and default workflows
We can use harmony to integrate multiple datasets, grouping equivelent cell types between samples. Harmony is an algorithm that iteratively adjusts cell coordinates in a reduced-dimensional space to correct for dataset-specific effects. It uses fuzzy clustering to assign cells to multiple clusters, calculates dataset-specific correction factors, and applies these corrections to each cell, repeating the process until the influence of the dataset diminishes.
```{r,eval=FALSE}
library(harmony)

## run harmony integration
combined_pros = runGiottoHarmony(combined_pros, vars_use = 'list_ID', do_pca = F)
```

### Clustering harmonized object
```{r, eval=FALSE}
## sNN network (default)
combined_pros <- createNearestNetwork(gobject = combined_pros,
                                  dim_reduction_to_use = 'harmony', dim_reduction_name = 'harmony', name = 'NN.harmony',
                                  dimensions_to_use = 1:10, k = 15)

## Leiden clustering
combined_pros <- doLeidenCluster(gobject = combined_pros,
                             network_name = 'NN.harmony', resolution = 0.2, n_iterations = 1000, name = 'leiden_harmony')

# UMAP dimension reduction
combined_pros = runUMAP(combined_pros, dim_reduction_name = 'harmony', dim_reduction_to_use = 'harmony', name = 'umap_harmony')

spatDimPlot2D(gobject = combined_pros,
              dim_reduction_to_use = 'umap', dim_reduction_name = 'umap_harmony',
              cell_color = 'leiden_harmony', show_image = T, image_name = c("NP-image", "CP-image"),
              spat_point_size = 1, save_param = list(save_name = "leiden_clustering_harmony"))
```
```{r, echo=FALSE, out.width="100%", fig.align="center", fig.cap="Leiden clustering after harmony was performed for the normal prostate (left) and the adenocarcinoma prostate sample (right)."}
knitr::include_graphics("img/03_session1/leiden_clustering_harmony.png")
```


### Vizualizing the tissue contribution
We can see that after performing harmony that the clusters from the two tissue samples are now clustered together. There is still a cluster that is unique to the adenocarcinoma sample, however this is expected as this represents the visium spots that cover the tumor regions of the tissue, which are not found in the normal tissue.
```{r, eval=FALSE}
 spatDimPlot2D(gobject = combined_pros,
               dim_reduction_to_use = 'umap', dim_reduction_name = 'umap_harmony',
               cell_color = 'list_ID', save_plot = TRUE,
               save_param = list(save_name = "leiden_clustering_harmony_contribution"))
```
```{r, echo=FALSE, out.width="100%", fig.align="center", fig.cap="Tissue contribution for leiden clustering after harmony for the normal prostate (left) and the adenocarcinoma prostate sample (right)."}
knitr::include_graphics("img/03_session1/leiden_clustering_harmony_contribution.png")
```

