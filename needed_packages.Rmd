# Needed packages


## Cran dependencies:
```{r}
cran_dependencies <-
    c("BiocManager",
      "devtools",
      "pak")

install.packages(cran_dependencies, Ncpus = 4)
```

## terra installation
_terra_ may have some additional steps when installing depending on which system you are on. Please see the _terra_ [repo](https://github.com/rspatial/terra) for specifics.
Installations of the CRAN release on Windows and Mac are expected to be simple, only requiring the code below. 

For Linux, there are several prerequisite installs: GDAL (>= 2.2.3), GEOS (>= 3.4.0), PROJ (>= 4.9.3), sqlite3

On our AlmaLinux 8 HPC, the following versions have been working well.
gdal/3.6.4, geos/3.11.1, proj/9.2.0, sqlite3/3.37.2
```{r}
install.packages("terra")
```

## Matrix installation
!! FOR R VERSIONS LOWER THAN 4.4.0 !!
_Giotto_ requires _Matrix_ 1.6-2 or greater, but when installing _Giotto_ with _pak_ on an _R_ version lower than 4.4.0, there are sometimes weird messages. We can solve this by installing the 1.6-5 version directly by uncommenting and running the line below.
```{r}
# devtools::install_version("Matrix", version = "1.6-5")
```

## Giotto installation
```{r}
pak::pak("drieslab/Giotto")
pak::pak("drieslab/GiottoData")
```

## irlba install
Reinstall _irlba_ from source. Avoids the common `function 'as_cholmod_sparse' not provided by package 'Matrix'` error. See this [issue](https://github.com/bwlewis/irlba/issues/70) for more info.
```{r}
install.packages("irlba", type = "source")
```

## arrow install
_arrow_ is a suggested package that we use here to open `parquet` files. The parquet files that 10X provides use zstd compression which the default _arrow_ installation may not provide.
```{r}
has_arrow <- requireNamespace("arrow", quietly = TRUE)
zstd <- TRUE
if (has_arrow) {
    zstd <- arrow::arrow_info()$capabilities[["zstd"]]
}
if (!has_arrow || !zstd) {
    Sys.setenv(ARROW_WITH_ZSTD = "ON") 
    install.packages("arrow", repos = c("https://apache.r-universe.dev"))
}
```

## Biocondutor dependencies:
```{r}
bioc_dependencies <- c(
    "scran",
    "ComplexHeatmap",
    "SpatialExperiment",
    "ggspavis",
    "scater",
    "nnSVG"
)
```

## Cran packages:
```{r}
needed_packages_cran <- c(
    "dplyr",
    "gstat",
    "hdf5r",
    "miniUI",
    "shiny",
    "xml2",
    "future",
    "future.apply",
    "exactextractr",
    "tidyr",
    "viridis",
    "quadprog",
    "Rfast",
    "pheatmap",
    "patchwork",
    "Seurat",
    "SeuratData",
    "harmony",
    "scatterpie",
    "R.utils",
    "qs"
)

pak::pkg_install(c(bioc_dependencies,
                   needed_packages_cran))
```


## Packages from GitHub
```{r}
github_packages <- c(
    "satijalab/seurat-data"
)
pak::pkg_install(github_packages)
```

## Python environments
```{r}
# default giotto environment
Giotto::installGiottoEnvironment()

# install another environment with py 3.8 for cellpose
reticulate::conda_create(envname = "giotto_cellpose",
                         python_version = 3.8)
reticulate::py_install(
    pip = TRUE,
    envname = 'giotto_cellpose',
    packages = c(
        "pandas",
        "networkx",
        "python-igraph",
        "leidenalg",
        "scikit-learn",
        "cellpose",
        "smfishhmrf",
        "git+https://github.com/wwang-chcn/bento-tools.git@giotto_install"
    )
)
```

